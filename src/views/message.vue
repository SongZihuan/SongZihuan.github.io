<script setup lang="ts">
  import { ElDivider, ElMessage } from 'element-plus'
  import { sendMsgToMail } from '@/api/message/sendmsg'
  import { isEmail } from '@/utils/str'

  const router = useRouter()

  const loading = ref(false)
  const show = ref(true)
  const form = ref({
    name: '',
    email: '',
    message: ''
  })

  const checkMessageShort = computed(() => form.value.message.length >= 1)
  const checkMessageLong = computed(() => form.value.message.length <= 50000)
  const checkName = computed(() => form.value.name.length <= 25)
  const checkEmail = computed(
    () => form.value.email == '' || (form.value.email.length < 40 && isEmail(form.value.email))
  )
  const checkAll = computed(
    () => checkMessageShort.value && checkMessageLong.value && checkName.value && checkEmail.value
  )

  function handleWindowResize() {
    show.value = window.innerWidth >= 240
  }
  window.addEventListener('resize', handleWindowResize)
  handleWindowResize()

  const reset = () => {
    form.value.message = ''
  }

  const backToHome = () => {
    router.push('/')
  }

  const sendMsg = () => {
    if (!checkAll.value) {
      return
    }

    loading.value = true
    sendMsgToMail(form.value.name, form.value.email, form.value.message)
      .then((response) => {
        const data = response.data
        if (data.success) {
          reset()
          ElMessage({
            message: data.message || 'ÁïôË®ÄÊàêÂäü',
            type: 'success'
          })
        } else {
          ElMessage({
            message: data.message || 'ÁïôË®ÄÂ§±Ë¥•',
            type: 'error'
          })
        }
      })
      .finally(() => (loading.value = false))
  }
</script>

<template>
  <div v-if="show" class="outside_box">
    <div class="inner_box">
      <div class="title_a">ÂÆãÂ≠êÊ°ì-ÁîµÂ≠ê‰ø°ÁÆ±üìß</div>

      <el-divider direction="horizontal" class="divider_horizontal"></el-divider>

      <div v-loading="loading" class="card_outside">
        <el-card class="card_box">
          <el-form :model="form" label-width="auto">
            <el-form-item label="‰Ω†ÁöÑÂêçÂ≠óÔºàYour nameÔºâ">
              <el-input v-model="form.name" :maxlength="25" clearable show-word-limit />
            </el-form-item>

            <el-form-item label="‰Ω†ÁöÑÈÇÆÁÆ±ÔºàYour emailÔºâ">
              <el-input v-model="form.email" :maxlength="40" clearable show-word-limit />
            </el-form-item>

            <el-form-item label="‰Ω†ÁöÑÁïôË®ÄÔºàYour messageÔºâ">
              <el-input v-model="form.message" type="textarea" :minlength="1" :rows="10" clearable show-word-limit />
            </el-form-item>
          </el-form>
          <div class="center_btn_box">
            <el-button-group>
              <el-button size="large" type="primary" :disabled="loading" @click="backToHome"> ËøîÂõû‰∏ªÈ°µ </el-button>
              <el-button size="large" type="success" :disabled="!checkAll || loading" @click="sendMsg">
                Êèê‰∫§
              </el-button>
            </el-button-group>
          </div>
          <div class="center_tips_box">
            <div class="tips_box">
              <div v-if="!checkName" class="tip_box" style="display: flex; justify-content: center">
                <el-alert title="ÂêçÂ≠ó‰∏çËÉΩË∂ÖËøá25‰ΩçÔºåÈÄâÂ°´ÔºÅ" :closable="false" type="warning" center show-icon>
                </el-alert>
              </div>
              <div v-if="!checkEmail" class="tip_box" style="display: flex; justify-content: center">
                <el-alert
                  title="ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÈÇÆÁÆ±Ôºå‰∏çÂæóË∂ÖËøá40‰∏™Â≠óÁ¨¶ÔºåÈÄâÂ°´ÔºÅ"
                  :closable="false"
                  type="warning"
                  center
                  show-icon
                >
                </el-alert>
              </div>
              <div v-if="!checkMessageLong" class="tip_box" style="display: flex; justify-content: center">
                <el-alert
                  title="Ê∂àÊÅØÁöÑÈïøÂ∫¶Â§™ÈïøÔºåÂèØÈááÁî®ÈÇÆ‰ª∂ÂΩ¢ÂºèÂèëÈÄÅÔºÅ"
                  :closable="false"
                  type="warning"
                  center
                  show-icon
                >
                </el-alert>
              </div>
              <div v-if="!checkMessageShort" class="tip_box" style="display: flex; justify-content: center">
                <el-alert title="Ê∂àÊÅØ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ" :closable="false" type="warning" center show-icon> </el-alert>
              </div>
            </div>
          </div>
        </el-card>
      </div>
    </div>
  </div>
</template>

<style scoped lang="scss">
  .outside_box {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .inner_box {
    width: 80%;
  }

  .title_a {
    width: 100%;
    font-size: 2.5rem;
    color: black;
    text-align: center;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .card_outside {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .card_box {
    width: calc(min(75%, 800px));
  }

  .center_btn_box,
  .center_tips_box {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .tips_box {
    width: 75%;
    margin-top: 5px;
  }

  .tip_box {
    margin-bottom: 5px;
  }
</style>
